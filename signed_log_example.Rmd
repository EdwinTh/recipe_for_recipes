---
author: Edwin Thoen
title: "A recipe for recipes: extra example"
subtitle: "eRum 2018 @ Budapest"
date: May 15, 2018
output: ioslides_presentation
---
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(rlang)
library(recipes)
```

```{r, echo=FALSE}
## load some function from the source code
source("~/Documents/R_packages/recipes/R/selections.R")
source("~/Documents/R_packages/recipes/R/recipe.R")
source("~/Documents/R_packages/recipes/R/misc.R")
```

## Example 2: A signed log

In *Practical Data Science with R* (Zumel and Mount) the authors define the signed log as:

if |x| < 1: 0

else:       sign(x) * log(|x|)

## 1) the function for this is:
```{r}
signed_log <- function(x, base = exp(1)) {
  ifelse(abs(x) < 1, 
         0, 
         sign(x) * log(abs(x), base = base))
}
```

## 2) think about the arguments

We have one argument: `base`

Nothing has to be derived by `prep.signed_log`

## 3) The constructor

```{r}
step_signed_log_new <-
  function(terms   = NULL,
           role    = NA,
           skip    = FALSE,
           trained = FALSE,
           base    = NULL,
           columns = NULL) {
    step(
      subclass = "signed_log",
      terms    = terms,
      role     = role,
      skip     = skip,
      trained  = trained,
      base     = base,
      columns  = columns
    )
  }
```

## 4) the function to add it to the recipe

```{r}
step_signed_log <-
  function(recipe,
           ...,
           role    = NA,
           skip    = FALSE,
           trained = FALSE,
           base    = exp(1),
           columns = NULL) {
    add_step(
      recipe,
      step_signed_log_new(
        terms   = ellipse_check(...),
        role    = role,
        skip    = skip,
        trained = trained,
        base    = base,
        columns = columns
      )
    )
  }
```

## 5) the `prep` method

```{r}
prep.step_signed_log <- function(x,
                                 training,
                                 info = NULL, 
                                  ...) {
  col_names <- terms_select(x$terms, info = info)
  step_signed_log_new(
    terms   = x$terms,
    role    = x$role,
    skip    = x$skip,
    trained = TRUE,
    base    = x$base,
    columns = col_names
  )
}
```

## 6) the `bake` method

```{r}

bake.step_signed_log <- function(object,
                                 newdata,
                                 ...) {
  col_names <- object$columns
  for (i in seq_along(col_names)) {
    col <- newdata[[ col_names[i] ]]
    newdata[, col_names[i]] <-
      ifelse(abs(col) < 1, 
             0, 
             sign(col) * log(abs(col), base = object$base))
  }
  as_tibble(newdata)
}
```

## 7) the `print` method 

```{r}
print.step_signed_log <-
  function(x, width = max(20, options()$width - 30), ...) {

    cat("Taking the signed log for ", sep = "")
    printer(x$columns, x$terms, x$trained, width = width)

    invisible(x)
}
```

## 8) the `tidy` method

```{r}
tidy.step_signed_log <- function(x, ...) {
  if (is_trained(x)) {
    res <- tibble(terms = x$columns)
  } else {
    res <- tibble(terms = sel2char(x$terms))
  }
  res
}
```

## Put it in practise

```{r}
df <- data_frame(x = -2:2)
recipe(df) %>% step_signed_log(x) %>% prep() %>% bake(df)
```
